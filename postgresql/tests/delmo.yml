suite:
  name: starkandwayne-postgresql
  system: docker-compose.yml
  task_service: tests

tests:
- name: persist-value-standalone
  spec:
  - wait: is-ready-standalone
  - exec:
    - persist-value-standalone
  - assert:
    - retrieve-value-standalone

- name: replication
  spec:
  - wait: is-ready-cluster
  - exec:
    - persist-value-cluster
  - assert:
    - retrieve-value-pg1
    - retrieve-value-pg2
    - retrieve-value-pg3

tasks:
- name: is-ready-standalone
  command: /scripts/pg-ready standalone
- name: persist-value-standalone
  command: /scripts/persist-value standalone foo bar
- name: retrieve-value-standalone
  command: /scripts/retrieve-value standalone foo bar

- name: retrieve-value-pg1
  command: /scripts/retrieve-value pg1 foo bar
- name: retrieve-value-pg2
  command: /scripts/retrieve-value pg2 foo bar
- name: retrieve-value-pg3
  command: /scripts/retrieve-value pg3 foo bar

- name: is-ready-cluster
  command: /scripts/pg-ready cluster
- name: persist-value-cluster
  command: /scripts/persist-value cluster foo bar
- name: retrieve-value-cluster
  command: /scripts/retrieve-value cluster foo bar
- name: persist-other-value-cluster
  command: /scripts/persist-value cluster foo other
- name: retrieve-other-value-cluster
  command: /scripts/retrieve-value cluster foo other
- name: leader-is-gone
  command: /scripts/leader-is-gone
